<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Time to Gulf (MVP)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Mapbox GL JS -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.5.1/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.5.1/mapbox-gl.css" rel="stylesheet"/>

  <!-- Mapbox Search JS Web Component -->
  <script defer src="https://api.mapbox.com/search-js/v1.5.0/web.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 0; }
    .wrap { padding: 16px; max-width: 1100px; margin: auto; }
    .row { display: flex; flex-wrap: wrap; gap: 12px; align-items: end; }
    label { font-size: 12px; opacity: 0.8; display:block; margin-bottom: 6px; }

    select, button {
      padding: 10px;
      font-size: 14px;
      height: 42px;
      width: 290px;
      box-sizing: border-box;
    }

    button {
      cursor: pointer;
      background: #0b5ed7;
      color: white;
      border: none;
      width: 180px;
    }

    mapbox-search-box {
      width: 420px;
      display: block;
      height: 42px;
    }

    #map { height: 520px; border-top: 1px solid #ddd; margin-top: 12px; }
    .results { margin-top: 12px; padding: 12px; background: #f7f7f7; border: 1px solid #e5e5e5; }
    .small { font-size: 12px; opacity: 0.75; margin-top: 8px; line-height: 1.35; }
    .hint { font-size: 12px; margin-top: 6px; opacity: 0.85; }
  </style>
</head>

<body>
  <div class="wrap">
    <h2>Time to Gulf (MVP)</h2>

    <div class="row">
      <div>
        <label>Address</label>
        <mapbox-search-box id="searchBox"></mapbox-search-box>
        <div class="hint" id="selectedHint">Selected: none</div>
      </div>

      <div>
        <label>Destination</label>
        <select id="dest">
          <optgroup label="Open Water">
            <option value="openWater">Nearest Open Water (closest exit)</option>
            <option value="matlacha">Matlacha Pass</option>
            <option value="riverCapeHarbour">Caloosahatchee River (Cape Harbour)</option>
            <option value="riverYachtClub">Caloosahatchee River (Yacht Club)</option>
            <option value="riverSE">Caloosahatchee River (SE Cape)</option>
          </optgroup>

          <optgroup label="Islands">
            <option value="sanibelCauseway">Sanibel Island (Causeway)</option>
            <option value="sanibelLighthouse">Sanibel Lighthouse</option>
            <option value="captivaSouthSeas">Captiva Island (South Seas)</option>
            <option value="cayoCosta">Cayo Costa</option>
            <option value="useppa">Useppa Island</option>
            <option value="bocaGrande">Boca Grande (Gasparilla)</option>
            <option value="pineIsland">Pine Island (Bokeelia)</option>
            <option value="loversKey">Lovers Key</option>
            <option value="fmbTimesSquare">Fort Myers Beach (Times Square)</option>
          </optgroup>
        </select>
      </div>

      <div>
        <label>Speed Mode</label>
        <select id="speed">
          <option value="conservative">Conservative</option>
          <option value="fast">Fast</option>
        </select>
      </div>

      <button id="calc">Calculate</button>
    </div>

    <div class="results" id="results">
      Start typing an address and select it from the list.
    </div>

    <div class="small">
      Disclaimer: Estimates only. Not for navigation. Open Water uses the closest exit anchor and does not yet follow canals.
    </div>
  </div>

  <div id="map"></div>

  <script>
    // =========================
    // CONFIG
    // =========================
    const MAPBOX_TOKEN = "pk.eyJ1IjoidGltZXRvZ3VsZnN3ZmwiLCJhIjoiY21sNXF3aDRkMDZrYjNlcHJmM3gxOWE4dCJ9.l1D8DbGoXWddoYTxZNV0MQ";
    mapboxgl.accessToken = MAPBOX_TOKEN;

    // =========================
    // DESTINATIONS
    // =========================
    const destinations = {
      // Open Water exits (auto-pick nearest)
      openWater: {
        name: "Nearest Open Water",
        exits: [
          { name: "Matlacha Pass Exit", lng: -82.1168, lat: 26.6352 },
          { name: "River Exit (Cape Harbour)", lng: -82.0096, lat: 26.5406 },
          { name: "River Exit (Yacht Club)", lng: -81.9706, lat: 26.5450 },
          { name: "River Exit (SE Cape)", lng: -81.9415, lat: 26.5480 },
          { name: "Pine Island Sound (near Matlacha)", lng: -82.1065, lat: 26.6510 }
        ]
      },

      // Specific open-water anchors
      matlacha: { name: "Matlacha Pass", lng: -82.1168, lat: 26.6352 },
      riverCapeHarbour: { name: "Caloosahatchee River (Cape Harbour)", lng: -82.0096, lat: 26.5406 },
      riverYachtClub: { name: "Caloosahatchee River (Yacht Club)", lng: -81.9706, lat: 26.5450 },
      riverSE: { name: "Caloosahatchee River (SE Cape)", lng: -81.9415, lat: 26.5480 },

      // Islands (anchor points)
      sanibelCauseway: { name: "Sanibel Island (Causeway)", lng: -82.0826, lat: 26.4807 },
      sanibelLighthouse: { name: "Sanibel Lighthouse", lng: -82.0182, lat: 26.4524 },
      captivaSouthSeas: { name: "Captiva Island (South Seas)", lng: -82.1930, lat: 26.5218 },
      cayoCosta: { name: "Cayo Costa", lng: -82.2445, lat: 26.6676 },
      useppa: { name: "Useppa Island", lng: -82.2256, lat: 26.6442 },
      bocaGrande: { name: "Boca Grande (Gasparilla)", lng: -82.2622, lat: 26.7477 },
      pineIsland: { name: "Pine Island (Bokeelia)", lng: -82.1586, lat: 26.7076 },
      loversKey: { name: "Lovers Key", lng: -81.9515, lat: 26.3939 },
      fmbTimesSquare: { name: "Fort Myers Beach (Times Square)", lng: -81.9488, lat: 26.4528 }
    };

    // MVP "water path factor" (fake canal distance)
    const multipliers = { conservative: 1.9, fast: 1.4 };

    // =========================
    // MAP INIT
    // =========================
    const map = new mapboxgl.Map({
      container: "map",
      style: "mapbox://styles/mapbox/streets-v12",
      center: [-81.95, 26.63],
      zoom: 10.8
    });

    let mapReady = false;
    map.on("load", () => { mapReady = true; });

    let startMarker = null;
    let endMarker = null;
    let selectedStart = null;

    const resultsEl = document.getElementById("results");
    const selectedHintEl = document.getElementById("selectedHint");

    // =========================
    // HELPERS
    // =========================
    function extractCoordsFromRetrieveEvent(e) {
      const d = e?.detail;

      if (d?.geometry?.coordinates?.length === 2) {
        return {
          lng: d.geometry.coordinates[0],
          lat: d.geometry.coordinates[1],
          place: d.properties?.full_address || d.properties?.name || d.place_name || "Selected address"
        };
      }

      const f = d?.features?.[0];
      if (f?.geometry?.coordinates?.length === 2) {
        return {
          lng: f.geometry.coordinates[0],
          lat: f.geometry.coordinates[1],
          place: f.properties?.full_address || f.properties?.name || f.place_name || "Selected address"
        };
      }

      return null;
    }

    function miles(a, b) {
      const R = 3958.8;
      const dLat = (b.lat - a.lat) * Math.PI / 180;
      const dLng = (b.lng - a.lng) * Math.PI / 180;
      const x =
        Math.sin(dLat / 2) ** 2 +
        Math.cos(a.lat * Math.PI / 180) *
        Math.cos(b.lat * Math.PI / 180) *
        Math.sin(dLng / 2) ** 2;
      return 2 * R * Math.asin(Math.sqrt(x));
    }

    function pickNearestExit(start, exits) {
      let best = exits[0];
      let bestDist = Infinity;

      for (const ex of exits) {
        const d = miles(start, ex);
        if (d < bestDist) {
          bestDist = d;
          best = ex;
        }
      }
      return best;
    }

    function drawRouteLine(start, end) {
      if (!mapReady) return;

      const id = "route-line";
      const geo = {
        type: "Feature",
        geometry: {
          type: "LineString",
          coordinates: [
            [start.lng, start.lat],
            [end.lng, end.lat]
          ]
        }
      };

      if (map.getSource(id)) {
        map.getSource(id).setData(geo);
      } else {
        map.addSource(id, { type: "geojson", data: geo });
        map.addLayer({
          id,
          type: "line",
          source: id,
          paint: { "line-color": "#0b5ed7", "line-width": 4 }
        });
      }
    }

    // =========================
    // SEARCH BOX INIT
    // =========================
    function initSearchBox() {
      const searchBox = document.getElementById("searchBox");
      if (!searchBox) return;

      searchBox.accessToken = MAPBOX_TOKEN;
      searchBox.proximity = "-81.95,26.63";
      searchBox.options = { country: "US", types: "address" };

      searchBox.addEventListener("retrieve", (e) => {
        const start = extractCoordsFromRetrieveEvent(e);
        if (!start) return;

        selectedStart = start;
        selectedHintEl.textContent = "Selected: " + start.place;
        resultsEl.textContent = "Now pick a destination and click Calculate.";
      });
    }

    if (window.customElements && customElements.whenDefined) {
      customElements.whenDefined("mapbox-search-box").then(() => {
        initSearchBox();
      });
    } else {
      window.addEventListener("DOMContentLoaded", initSearchBox);
    }

    // =========================
    // CALCULATE
    // =========================
    document.getElementById("calc").onclick = () => {
      if (!selectedStart) {
        resultsEl.innerText = "Please select an address from the suggestions first.";
        return;
      }

      const destKey = document.getElementById("dest").value;
      const speedKey = document.getElementById("speed").value;

      let end;
      if (destKey === "openWater") {
        end = pickNearestExit(selectedStart, destinations.openWater.exits);
      } else {
        end = destinations[destKey];
      }

      const dist = miles(selectedStart, end) * multipliers[speedKey];
      const mph = speedKey === "fast" ? 18 : 12;
      const minutes = Math.round((dist / mph) * 60);

      resultsEl.innerHTML = `
        <div><strong>${minutes} minutes</strong></div>
        <div>${dist.toFixed(1)} miles to ${end.name}</div>
      `;

      if (startMarker) startMarker.remove();
      if (endMarker) endMarker.remove();

      startMarker = new mapboxgl.Marker().setLngLat([selectedStart.lng, selectedStart.lat]).addTo(map);
      endMarker = new mapboxgl.Marker().setLngLat([end.lng, end.lat]).addTo(map);

      drawRouteLine(selectedStart, end);

      map.fitBounds(
        [[selectedStart.lng, selectedStart.lat], [end.lng, end.lat]],
        { padding: 60 }
      );
    };
  </script>
</body>
</html>
